extends ../../components/base/_skeleton
include ../../components/rd-navbar/_rd-navbar
include ../../components/modal-dynamic/_modal-dynamic
include ../../components/helpers/_helpers

block variables
  - pageName = title;
  - htmlClass.push('page-small-footer');

block page
  header.section.page-header
    +rd-navbar

  section.section-xs
    .container-fluid
      .row
        .col-12
          .panel
            // --- Header with responsive back button ---
            .panel-header.d-flex.flex-column.flex-md-row.align-items-md-center.justify-content-between
              h5.panel-title.mb-2.mb-md-0
                span.panel-icon.linearicons-cog
                = ' '
                span= title
              .d-flex.flex-wrap
                a.btn.btn-outline-secondary(href='/teams/mediabuying')
                  span.linearicons-arrow-left.mr-2
                  | До списку команд

            .panel-body
              // --- Filters (search + selects) ---
              form.form-inline.mb-3(method='GET', action='/teams/mediabuying/management')
                .form-group.mb-2.mr-2.mt-0
                  input.form-control(
                    type='text',
                    name='q',
                    size=24,
                    placeholder='Пошук (імʼя/WebID)',
                    value=(query && query.q || '')
                  )
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='orgRole')
                    option(value='') Доступ: всі
                    if options && options.orgRoles && options.orgRoles.length
                      each r in options.orgRoles
                        option(value=r.value selected=(query && query.orgRole===r.value) ? true : false)= r.label || r.value
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='deptRole')
                    option(value='') Посада у відділі: всі
                    if options && options.deptRolesByDept && options.deptRolesByDept.length
                      each dr in options.deptRolesByDept
                        option(value=dr.value selected=(query && query.deptRole===dr.value) ? true : false)= dr.label || dr.value
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='teamRole')
                    option(value='') Посада у команді: всі
                    if options && options.teamRolesByDept && options.teamRolesByDept.length
                      each trr in options.teamRolesByDept
                        option(value=trr.value selected=(query && query.teamRole===trr.value) ? true : false)= trr.label || trr.value
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='team')
                    option(value='') Команда: всі
                    if options && options.teams && options.teams.length
                      each t in options.teams
                        option(value=String(t._id) selected=(query && String(query.team)===String(t._id)) ? true : false)= t.name
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='assistantOf')
                    option(value='') Наставник: всі
                    if options && options.supervisors && options.supervisors.length
                      each s in options.supervisors
                        - const supName = `${s.firstName || ''} ${s.lastName || ''}`.trim() || s.email || String(s._id)
                        option(value=String(s._id) selected=(query && String(query.assistantOf)===String(s._id)) ? true : false)= supName
                .form-group.mb-2.mr-2.mt-0
                  select.form-control(name='limit')
                    option(value='20' selected=(pagination && +pagination.limit===20)) 20
                    option(value='50' selected=(pagination && +pagination.limit===50)) 50
                button.btn.btn-light.ml-2.mb-2.mt-0(type='submit')
                  span.linearicons-magnifier
                a.btn.btn-outline-secondary.ml-2.mb-2(href='/teams/mediabuying/management', title='Очистити фільтри')
                  span.linearicons-trash2

              // --- Flash ---
              if userError && userError.length
                +alert({close:false}).alert-danger.alert-sm.mb-3
                  span.alert-icon.fa-exclamation-triangle
                  if Array.isArray(userError)
                    each e in userError
                      span= e
                      br
                  else
                    span= userError

              // Prepare team names map (optional for client-side usage)
              - const teamNameById = {};
              if options && options.teams && options.teams.length
                each t in options.teams
                  - teamNameById[String(t._id)] = t.name;

              // --- Table (SSR rows) ---
              .table-responsive
                table#usersTable.table.table-striped.mt-2.mb-4(data-department=department)
                  thead
                    tr
                      th(style='width:20px') №
                      th(style='min-width:280px') Співробітник
                      th(style='min-width:150px')
                        span(data-toggle='tooltip' data-original-title='OrgRole')
                          | Доступ
                      th(style='min-width:180px')
                        span(data-toggle='tooltip' data-original-title='DeptRole')
                          | Посада у відділі
                      th(style='min-width:160px')
                        span(data-toggle='tooltip' data-original-title='TeamRole')
                          | Посада у команді
                      th(style='min-width:140px') Команда
                      th(style='min-width:170px')
                        span(data-toggle='tooltip' data-original-title='Тільки для асистента')
                          | Наставник
                      th(style='width:80px') WebID
                      th(style='width:120px; text-align:center') Статус
                  tbody
                    if users && users.length
                      each u, idx in users
                        - const __name    = `${u.firstName || ''} ${u.lastName || ''}`.trim() || u.email || '—';
                        - const __isAdmin = (u.orgRole === 'admin');
                        - const __isHead  = (u.deptRole === 'head');
                        - const __tRole   = u.teamRole || null;
                        - const __canWeb  = (department === 'Media Buying') && (__tRole === 'lead' || __tRole === 'member') && !__isAdmin && !__isHead;
                        - const __disDeptRole = __isAdmin;
                        - const __disTeamRole = __isAdmin || __isHead;
                        - const __disTeam     = __isAdmin || __isHead || !(__tRole === 'lead' || __tRole === 'member');
                        - const __disSup      = __isAdmin || __isHead || !(__tRole === 'assistant');
                        - const __disWeb      = __isAdmin || __isHead || !__canWeb;

                        tr(data-user-id=String(u._id))
                          td= idx + 1
                          td
                            img.rounded-circle.mr-2(
                              src=`/users/${u._id}/avatar`,
                              alt=__name,
                              width='38',
                              height='38',
                              style='object-fit:cover;vertical-align:middle;'
                            )
                            span.fw-semibold= __name
                          td
                            select.form-control.form-control-sm.js-field(name='orgRole' data-field='orgRole')
                              if options && options.orgRoles && options.orgRoles.length
                                each r in options.orgRoles
                                  option(
                                    value=r.value
                                    selected=(u.orgRole===r.value) ? true : false
                                  )= r.label || r.value
                          td
                            select.form-control.form-control-sm.js-field(
                              name='deptRole'
                              data-field='deptRole'
                              disabled=__disDeptRole ? true : false
                            )
                              option(value='' selected=(u.deptRole==null) ? true : false) —
                              if options && options.deptRolesByDept && options.deptRolesByDept.length
                                each dr in options.deptRolesByDept
                                  option(
                                    value=dr.value
                                    selected=(u.deptRole===dr.value) ? true : false
                                  )= dr.label || dr.value
                          td
                            select.form-control.form-control-sm.js-field(
                              name='teamRole'
                              data-field='teamRole'
                              disabled=__disTeamRole ? true : false
                            )
                              option(value='') —
                              if options && options.teamRolesByDept && options.teamRolesByDept.length
                                each trr in options.teamRolesByDept
                                  option(
                                    value=trr.value
                                    selected=(u.teamRole===trr.value) ? true : false
                                  )= trr.label || trr.value
                          td
                            select.form-control.form-control-sm.js-field(
                              name='team'
                              data-field='team'
                              disabled=__disTeam ? true : false
                            )
                              option(value='') — не вибрано —
                              if options && options.teams && options.teams.length
                                each t in options.teams
                                  option(
                                    value=String(t._id)
                                    selected=(String(u.team)===String(t._id)) ? true : false
                                  )= t.name
                          td
                            select.form-control.form-control-sm.js-field(
                              name='assistantOf'
                              data-field='assistantOf'
                              disabled=__disSup ? true : false
                            )
                              option(value='') — не вибрано —
                              if options && options.supervisors && options.supervisors.length
                                each sv in options.supervisors
                                  if String(sv._id) !== String(u._id)
                                    - const svName = `${sv.firstName || ''} ${sv.lastName || ''}`.trim() || sv.email || String(sv._id)
                                    option(
                                      value=String(sv._id)
                                      selected=(String(u.assistantOf)===String(sv._id)) ? true : false
                                    )= svName
                          td
                            input.form-control.form-control-sm.js-field(
                              type='text'
                              name='webId'
                              data-field='webId'
                              value=(u.webId || '')
                              disabled=__disWeb ? true : false
                            )
                          td.text-center
                            span.js-status —
                    else
                      tr
                        td(colspan='10') em Користувачів не знайдено.

              // --- Pagination ---
              if pagination && pagination.totalPages > 1
                nav
                  ul.pagination
                    li.page-item(class=(pagination.page <= 1 ? 'disabled' : ''))
                      a.page-link(href=pagination.prevUrl) «
                    if pagination.pages && pagination.pages.length
                      each p in pagination.pages
                        li.page-item(class=(p.active ? 'active' : ''))
                          a.page-link(href=p.url)= p.n
                    li.page-item(class=(pagination.page >= pagination.totalPages ? 'disabled' : ''))
                      a.page-link(href=pagination.nextUrl) »

  +modal-dynamic
  include ../layout/footer

  block scripts
    script(defer src='/components/base/custom/teams-management.js')
